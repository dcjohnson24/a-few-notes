<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-02-04">

<title>A few notes - Refinitiv Assessment</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">A few notes</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/dcjohnson24"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Refinitiv Assessment</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">code</div>
                <div class="quarto-category">analysis</div>
                <div class="quarto-category">interview</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 4, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>This is an assessment I did for Refinitiv in May 2019. The data is available <a href="https://github.com/dcjohnson24/refinitiv-test">here</a>. I received an offer.</p>
<h1 id="Refinitive-Test">
Refinitive Test<a class="anchor-link" href="#Refinitive-Test">¶</a>
</h1>
<h2 id="Question-1" class="anchored">
Question 1<a class="anchor-link" href="#Question-1">¶</a>
</h2>
<p>
Examine the dataset in sheet ‘Question1_Data’ and answer the following questions:<br> 1.1 How many employees are currently employed (Inactive = 0)? Enter the formula in column P<br> 1.2 How many employees are actively employed in the IT Department in Cape Town? Enter the formula in column P<br> 1.3 What is the total number of leave days for all active employees in Cape Town? Enter the formula in column P
</p>
<p>
Begin by reading in the excel book and creating data frames in pandas
</p>
<div id="cell-6" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-7" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> Path.home() <span class="op">/</span> <span class="st">'refinitiv-test'</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>xls <span class="op">=</span> pd.ExcelFile(p <span class="op">/</span> <span class="st">'ExcelTest1.2.xlsx'</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>df_list <span class="op">=</span> [pd.read_excel(xls, sheet) <span class="cf">for</span> sheet <span class="kw">in</span> xls.sheet_names]</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>_, data1, _, data2, _, data3, _ <span class="op">=</span> df_list</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>
The first dataset <code>data1</code> has empty columns so we drop them
</p>
<div id="cell-9" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>data1.dropna(axis<span class="op">=</span><span class="dv">1</span>, how<span class="op">=</span><span class="st">'all'</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(data1.head())</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   EmployeeID DepartmentID       Office  InActive  Employee ID  LeaveDays
0           1           HR  East London         0            1          7
1           2           HR     Pretoria         0            2         13
2           3  Procurement    Cape Town         1            3         12
3           4  Procurement       Durban         1            4          7
4           5          R&amp;D    Cape Town         0            5          6</code></pre>
</div>
</div>
<h3 id="1.1" class="anchored">
1.1<a class="anchor-link" href="#1.1">¶</a>
</h3>
<p>
<strong>How many employees are currently employed (Inactive = 0)? Enter the formula in column P</strong>
</p>
<div id="cell-11" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Question 1.1</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>data1.InActive.value_counts()</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>InActive
1    1112
0    1097
Name: count, dtype: int64</code></pre>
</div>
</div>
<p>
We see that there are 1097 active employees
</p>
<h3 id="1.2" class="anchored">
1.2<a class="anchor-link" href="#1.2">¶</a>
</h3>
<p>
<strong>How many employees are actively employed in the IT Department in Cape Town? Enter the formula in column P</strong>
</p>
<p>
We take the rows for the IT department that have an <code>InActive</code> code of <code>0</code>
</p>
<div id="cell-15" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Question 1.2</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(data1[(data1.DepartmentID <span class="op">==</span> <span class="st">'IT'</span>) <span class="op">&amp;</span> (data1.InActive <span class="op">==</span> <span class="dv">0</span>)])</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>118</code></pre>
</div>
</div>
<p>
There are 118 people employed in the IT department in Cape Town
</p>
<h3 id="1.3" class="anchored">
1.3<a class="anchor-link" href="#1.3">¶</a>
</h3>
<p>
<strong>What is the total number of leave days for all active employees in Cape Town? Enter the formula in column P</strong>
</p>
<p>
Start by getting all the active employees in Cape Town
</p>
<div id="cell-19" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>cape_town <span class="op">=</span> data1[(data1.Office <span class="op">==</span> <span class="st">'Cape Town'</span>) <span class="op">&amp;</span> (data1.InActive<span class="op">==</span><span class="dv">0</span>)]</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cape_town.head())</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    EmployeeID DepartmentID     Office  InActive  Employee ID  LeaveDays
4            5          R&amp;D  Cape Town         0            5          6
6            7      Payroll  Cape Town         0            7         10
14          15          R&amp;D  Cape Town         0           15         12
31          32      Payroll  Cape Town         0           32          7
32          33           HR  Cape Town         0           33         14</code></pre>
</div>
</div>
<p>
Then sum up the leave days
</p>
<div id="cell-21" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>cape_town.LeaveDays.<span class="bu">sum</span>()</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>2379</code></pre>
</div>
</div>
<p>
There are a total of 2379 leave days
</p>
<h2 id="Question-2" class="anchored">
Question 2<a class="anchor-link" href="#Question-2">¶</a>
</h2>
<p>
Examine the dataset in sheet ‘Question2_Data’ and answer the following questions:<br> 2.1 How many distinct UIDs contain the Source URL ‘www.abc.com’?<br> 2.2 How many distinct UIDs contain duplicate Source URLs?<br> 2.3 How many distinct Source URLs does UID 2989625 have?
</p>
<h3 id="2.1" class="anchored">
2.1<a class="anchor-link" href="#2.1">¶</a>
</h3>
<p>
<strong>How many distinct UIDs contain the Source URL ‘www.abc.com’?</strong>
</p>
<p>
First we look for the distinct UIDs
</p>
<div id="cell-27" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>data2_dedup <span class="op">=</span> data2.drop_duplicates(subset<span class="op">=</span><span class="st">'UID'</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'There are '</span>, <span class="bu">len</span>(data2.UID), <span class="st">'UIDs in the data'</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'There are '</span>, data2.UID.nunique(), <span class="st">'distinct UIDs in the data'</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are  1329 UIDs in the data
There are  1219 distinct UIDs in the data</code></pre>
</div>
</div>
<p>
Next, search for the string www.abc.com in the Source URL string
</p>
<div id="cell-29" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>data2_dedup[<span class="st">'Source URLs'</span>].<span class="bu">str</span>.contains(<span class="st">'www.abc.com'</span>).<span class="bu">sum</span>()</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>568</code></pre>
</div>
</div>
<p>
There are 568 distinct UIDs that contain the source url ‘www.abc.com’
</p>
<h3 id="2.2" class="anchored">
2.2<a class="anchor-link" href="#2.2">¶</a>
</h3>
<p>
<strong>How many distinct UIDs contain duplicate Source URLs?</strong>
</p>
<p>
Using our de-duplicated data on UID, check for duplicates in the Source URL
</p>
<div id="cell-33" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>data2_dedup[<span class="st">'Source URLs'</span>].duplicated().<span class="bu">sum</span>()</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>1162</code></pre>
</div>
</div>
<p>
There are 1,162 duplicates in the Source URLs
</p>
<h3 id="2.3" class="anchored">
2.3<a class="anchor-link" href="#2.3">¶</a>
</h3>
<p>
<strong>How many distinct Source URLs does UID 2989625 have?</strong>
</p>
<p>
We check for rows where UID is 2989625 and then count the unique Source URLs for those rows
</p>
<div id="cell-37" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>data2[data2.UID <span class="op">==</span> <span class="dv">2989625</span>][<span class="st">'Source URLs'</span>].nunique()</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>1</code></pre>
</div>
</div>
<p>
There is only one unique source URL for UID 2989625
</p>
<h3 id="2.4" class="anchored">
2.4<a class="anchor-link" href="#2.4">¶</a>
</h3>
<p>
<strong>Provide the count of distinct citizens for each of the Countries in column O:</strong>
</p>
<p>
We start by breaking the <code>Citizenship</code> column into multiple columns to account for multiple nationalities
</p>
<div id="cell-41" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>citizen <span class="op">=</span> data2_dedup.CITIZENSHIP.<span class="bu">str</span>.split(<span class="st">';'</span>, expand<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>citizen.columns <span class="op">=</span> [<span class="st">'Citizenship1'</span>, <span class="st">'Citizenship2'</span>, <span class="st">'Citizenship3'</span>]</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(citizen.head())    </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Citizenship1 Citizenship2 Citizenship3
0          USA         None         None
1          USA   MOZAMBIQUE         None
2          USA         None         None
3          USA       CYPRUS         None
4          USA         None         None</code></pre>
</div>
</div>
<p>
Then we get the counts for each column
</p>
<div id="cell-43" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>citizen.Citizenship1.value_counts()</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>Citizenship1
USA    1219
Name: count, dtype: int64</code></pre>
</div>
</div>
<div id="cell-44" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>citizen.Citizenship2.value_counts()</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>Citizenship2
RUSSIAN FEDERATION    47
CYPRUS                33
ZAMBIA                31
MOZAMBIQUE            26
CHINA                 24
FRANCE                18
Name: count, dtype: int64</code></pre>
</div>
</div>
<div id="cell-45" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>citizen.Citizenship3.value_counts()</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>Citizenship3
PARAGUAY    18
Name: count, dtype: int64</code></pre>
</div>
</div>
<h3 id="2.5" class="anchored">
2.5<a class="anchor-link" href="#2.5">¶</a>
</h3>
<p>
<strong>Provide the count of individuals born between 1960 and 1970</strong>
</p>
<p>
Since there are multiple dates of birth for a person, we start by separating them
</p>
<div id="cell-48" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>dob <span class="op">=</span> data2_dedup.DOB.<span class="bu">str</span>.split(<span class="st">';'</span>, expand<span class="op">=</span><span class="va">True</span>).fillna(np.nan)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>dob.columns <span class="op">=</span> [<span class="ss">f'dob</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(dob.shape[<span class="dv">1</span>])]</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(dob.head())</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         dob0        dob1 dob2 dob3 dob4 dob5 dob6 dob7
0  1968/00/00         NaN  NaN  NaN  NaN  NaN  NaN  NaN
1         NaN         NaN  NaN  NaN  NaN  NaN  NaN  NaN
2  1955/03/01  1953/00/00  NaN  NaN  NaN  NaN  NaN  NaN
3         NaN         NaN  NaN  NaN  NaN  NaN  NaN  NaN
4         NaN         NaN  NaN  NaN  NaN  NaN  NaN  NaN</code></pre>
</div>
</div>
<p>
Since we are only interested in the year, we take the first part before the ‘/’ of every string of the form ‘yyyy/mm/dd’. We define a function that will extract the year portion of the string
</p>
<div id="cell-50" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> date_strip(x):</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>  pd.DataFrame(x.astype(<span class="bu">str</span>).<span class="bu">str</span>.split(<span class="st">'/'</span>).tolist()).iloc[:,<span class="dv">0</span>].astype(<span class="bu">float</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>
Applying the <code>date_strip</code> function to every column gives us
</p>
<div id="cell-52" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>years <span class="op">=</span> dob.<span class="bu">apply</span>(date_strip)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(years.head())</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     dob0    dob1  dob2  dob3  dob4  dob5  dob6  dob7
0  1968.0     NaN   NaN   NaN   NaN   NaN   NaN   NaN
1     NaN     NaN   NaN   NaN   NaN   NaN   NaN   NaN
2  1955.0  1953.0   NaN   NaN   NaN   NaN   NaN   NaN
3     NaN     NaN   NaN   NaN   NaN   NaN   NaN   NaN
4     NaN     NaN   NaN   NaN   NaN   NaN   NaN   NaN</code></pre>
</div>
</div>
<p>
Then we count the number of years of birth that are between 1960 and 1970 inclusive, being careful to check for people with multiple years that fall in the range to avoid double counting.
</p>
<p>
The function defined by <code>lambda</code> will count the number of birth years that are between 1960 and 1970
</p>
<div id="cell-54" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>years.<span class="bu">apply</span>(<span class="kw">lambda</span> x: ((x <span class="op">&gt;=</span> <span class="dv">1960</span>) <span class="op">&amp;</span> (x <span class="op">&lt;=</span> <span class="dv">1970</span>)).<span class="bu">sum</span>(), axis<span class="op">=</span><span class="dv">1</span>).value_counts()   </span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>0    1176
1      37
2       6
Name: count, dtype: int64</code></pre>
</div>
</div>
<p>
We can see that there are 37 people born between 1960 and 1970. The additional 6 are for people with different birthdates recorded but the same birth year
</p>
<h2 id="Question-3" class="anchored">
Question 3<a class="anchor-link" href="#Question-3">¶</a>
</h2>
<p>
Examine the dataset in sheet ‘Question3_Data’ and answer the following questions:<br> 3.1 For each of the TEJ_Code values, extract the number between underscore characters and list them in column C. What is the sum of all the extracted numbers?<br> 3.2 Replace the extracted number in the original TEJ_Code with the corresponding KW in Column K. Place the new TEJ_Code in a new column called ‘TEJ_Code_KW’
</p>
<h3 id="3.1" class="anchored">
3.1<a class="anchor-link" href="#3.1">¶</a>
</h3>
<p>
<strong>For each of the TEJ_Code values, extract the number between underscore characters and list them in column C. What is the sum of all the extracted numbers?</strong>
</p>
<p>
There are columns in <code>data3</code> that are empty so we drop them
</p>
<div id="cell-59" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>data3.dropna(axis<span class="op">=</span><span class="dv">1</span>, how<span class="op">=</span><span class="st">'all'</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>
Next, we extract the number part of the TEJ codes
</p>
<div id="cell-61" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>tej_codes <span class="op">=</span> data3.TEJ_Code.<span class="bu">str</span>.split(<span class="st">'_'</span>, expand<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tej_codes.head())</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     0   1        2
0  TEJ  64     DGHM
1  TEJ  75    WESGV
2  TEJ  61    SATRU
3  TEJ  35     AERH
4  TEJ  51  AQEWRGT</code></pre>
</div>
</div>
<p>
Then sum up the second column
</p>
<div id="cell-63" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>tej_codes.iloc[:,<span class="dv">1</span>].astype(<span class="bu">int</span>).<span class="bu">sum</span>()</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>49465</code></pre>
</div>
</div>
<p>
The sum of the numbers is 49465
</p>
<h3 id="3.2" class="anchored">
3.2<a class="anchor-link" href="#3.2">¶</a>
</h3>
<p>
<strong>Replace the extracted number in the original TEJ_Code with the corresponding KW in Column K. Place the new TEJ_Code in a new column called ‘TEJ_Code_KW’</strong>
</p>
<p>
Using the <code>tej_codes</code> subset from part 3.1, we rename the columns from 0, 1, 2 to ‘TEJ’, ‘ID’, ‘LAST’. We also cast the ID column as a float, so that it can be used to merge with <code>data3</code>
</p>
<div id="cell-67" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>tej_codes.columns <span class="op">=</span> [<span class="st">'TEJ'</span>, <span class="st">'ID'</span>, <span class="st">'LAST'</span>]</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>tej_codes.ID <span class="op">=</span> tej_codes.ID.astype(<span class="bu">float</span>)  </span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tej_codes.head())</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   TEJ    ID     LAST
0  TEJ  64.0     DGHM
1  TEJ  75.0    WESGV
2  TEJ  61.0    SATRU
3  TEJ  35.0     AERH
4  TEJ  51.0  AQEWRGT</code></pre>
</div>
</div>
<p>
Next, we match the integer parts with the ID column. After matching, we use the corresponding <code>KW</code> to create the new <code>TEJ_Code_KW</code> column.
</p>
<div id="cell-69" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>merged <span class="op">=</span> tej_codes.merge(data3, on<span class="op">=</span><span class="st">'ID'</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(merged.head())</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   TEJ    ID     LAST     UID       TEJ_Code   KW
0  TEJ  64.0     DGHM  289079    TEJ_34_DGHM  ghi
1  TEJ  75.0    WESGV  237266   TEJ_48_AERGH  stu
2  TEJ  61.0    SATRU   26111   TEJ_72_ADFRH  ijk
3  TEJ  35.0     AERH  260015  TEJ_60_ZDGTJH  lmn
4  TEJ  51.0  AQEWRGT   59990    TEJ_75_AE5Y  vwx</code></pre>
</div>
</div>
<p>
Finally, <code>TEJ_Code_KW</code> is created by concatenating the string <code>TEJ</code>, the <code>KW</code> and the last 4 characters.
</p>
<div id="cell-71" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>merged[<span class="st">'TEJ_Code_KW'</span>] <span class="op">=</span> merged[<span class="st">'TEJ'</span>] <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> merged[<span class="st">'KW'</span>] <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> merged[<span class="st">'LAST'</span>]</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(merged.head())</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(merged.tail())</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   TEJ    ID     LAST     UID       TEJ_Code   KW      TEJ_Code_KW
0  TEJ  64.0     DGHM  289079    TEJ_34_DGHM  ghi     TEJ_ghi_DGHM
1  TEJ  75.0    WESGV  237266   TEJ_48_AERGH  stu    TEJ_stu_WESGV
2  TEJ  61.0    SATRU   26111   TEJ_72_ADFRH  ijk    TEJ_ijk_SATRU
3  TEJ  35.0     AERH  260015  TEJ_60_ZDGTJH  lmn     TEJ_lmn_AERH
4  TEJ  51.0  AQEWRGT   59990    TEJ_75_AE5Y  vwx  TEJ_vwx_AQEWRGT
     TEJ    ID     LAST     UID          TEJ_Code   KW      TEJ_Code_KW
994  TEJ  73.0  ASFDREH   49161      TEJ_29_ASFDG  pqr  TEJ_pqr_ASFDREH
995  TEJ  75.0    DCGYJ  237266      TEJ_48_AERGH  stu    TEJ_stu_DCGYJ
996  TEJ  39.0     SDFH   50976  TEJ_80_DFGSAEFDG  vwx     TEJ_vwx_SDFH
997  TEJ  32.0    ADFRH   84768       TEJ_39_AE5Y  cde    TEJ_cde_ADFRH
998  TEJ  77.0     SADF  156696      TEJ_66_ASRTU  ghi     TEJ_ghi_SADF</code></pre>
</div>
</div>



</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>